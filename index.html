<!DOCTYPE html>
<html>
<head lang="pt">
    <meta charset="UTF-8">
    <title>Metaplasmador</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap theme -->
    <link href="css/bootstrap-theme.min.css" rel="stylesheet">
    <link href="css/metaplasmador.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="js/vendor/html5shiv.min.js"></script>
        <script src="js/vendor/respond.min.js"></script>
    <![endif]-->
</head>

<body role="document">

    <!-- Fixed navbar -->
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand" href="#">Metaplasmador</a>
            </div>
        </div>
    </div>

    <!-- Content -->
    <div class="container" role="main">
        <div class="jumbotron">
            <h1>Bem-vindo ao Metaplasmador!</h1>
       </div>

        <div class="panel panel-primary">
            <div class="panel-heading">
                <h3 class="panel-title">Metaplasmador</h3>
            </div>
            <div class="panel-body">
                <div class="input-group">
                    <input id="input" type="text" class="form-control" placeholder="Insira palavra em latim">
                    <span class="input-group-btn">
                        <button id="btn_aplicar" class="btn btn-primary" type="button" onclick="aplicarRegras()">Transformar!</button>
                    </span>
                </div><!-- /input-group -->
                <div class="btn-group" role="group" style="margin-top: 10px; margin-bottom: 20px">
                    <button class="btn btn-default" onclick="inserirCaracter(this)">ā</button>
                    <button class="btn btn-default" onclick="inserirCaracter(this)">ă</button>
                    <button class="btn btn-default" onclick="inserirCaracter(this)">ē</button>
                    <button class="btn btn-default" onclick="inserirCaracter(this)">ĕ</button>
                    <button class="btn btn-default" onclick="inserirCaracter(this)">ī</button>
                    <button class="btn btn-default" onclick="inserirCaracter(this)">ĭ</button>
                    <button class="btn btn-default" onclick="inserirCaracter(this)">ō</button>
                    <button class="btn btn-default" onclick="inserirCaracter(this)">ŏ</button>
                    <button class="btn btn-default" onclick="inserirCaracter(this)">ū</button>
                    <button class="btn btn-default" onclick="inserirCaracter(this)">ŭ</button>
                </div>
                <br />
                <table class="table well" style="font-family: 'Voces', cursive;">
                    <tr><th scope="row" style="width: 1px;">Entrada:</td><td id="input-ortografico"></td></tr>
                    <tr><th scope="row" style="width: 1px;">Fonético:</td><td id="input-fonetico"></td></tr>
                </table>
                <div class="well" style="font-family: 'Voces', cursive;" >
                    <div style="font-weight: bold; ">Saída:</div>
                    <div id="fulloutput" style="float: left;"></div>
                    <div id="output" style="float: left; font-weight: bold; margin-left: 2em"></div>
                    <div style="clear: both"></div>
                </div>
            </div>
        </div>

        <div class="row" style="font-family: 'Voces', cursive;">
            <div class="col-md-2 col-sm-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">S0</h3>
                    </div>
                    <div class="panel-body no-padding">
                        <textarea id="s0" class="form-control" rows="10"></textarea>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">S1</h3>
                    </div>
                    <div class="panel-body no-padding">
                        <textarea id="s1" class="form-control" rows="10"></textarea>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">S2</h3>
                    </div>
                    <div class="panel-body no-padding">
                        <textarea id="s2" class="form-control" rows="10"></textarea>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">S3</h3>
                    </div>
                    <div class="panel-body no-padding">
                        <textarea id="s3" class="form-control" rows="10"></textarea>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">S4</h3>
                    </div>
                    <div class="panel-body no-padding">
                        <textarea id="s4" class="form-control" rows="10"></textarea>
                    </div>
                </div>
            </div>
            <div class="col-md-2 col-sm-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">S5</h3>
                    </div>
                    <div class="panel-body no-padding">
                        <textarea id="s5" class="form-control" rows="10"></textarea>
                    </div>
                </div>
            </div>
        </div>
        <div class="row" style="font-family: 'Voces', cursive;">
            <div class="col-md-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Conjuntos</h3>
                    </div>
                    <div class="panel-body">
                        <textarea id="conjuntos" class="form-control" rows="10"></textarea>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Ortográfico > Fonético</h3>
                    </div>
                    <div class="panel-body">
                        <textarea id="orto2fone" class="form-control" rows="10"></textarea>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title">Fonético > Ortográfico</h3>
                    </div>
                    <div class="panel-body">
                        <textarea id="fone2orto" class="form-control" rows="10"></textarea>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Javascript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/conjunto.js"></script>
    <script src="js/regra.js"></script>
    <script src="js/regra-ambigua.js"></script>
    <script src="js/fileutils.js"></script>
    <script src="js/vendor/jquery-1.11.1.js"></script>
    <script src="js/vendor/bootstrap.min.js"></script>
    <script src="js/vendor/jquery-textrange.js"></script>

    <script>
        // Globals
        const numSincronias = 6;

        var _sincronias = []; // array de array de regras
        var _conjuntos = {}; // mapa nome -> elementos
        var modos = {
            ORTOGRAFICO: 0,
            FONETICO: 1,
            FONOLOGICO: 2
        };

        var modosnomes = ["Ortográfico", "Fonético", "Fonológico"];
        var _regrasOrto2Fone = [];
        var _regrasFone2Orto = [];
        var _regrasOrto2Fono = [];
        var _regrasFono2Orto = [];
        var _modo = modos.ORTOGRAFICO;

        $(document).ready(function(){
            $('#btn-modo').text("Modo: " + modosnomes[_modo]);
            loadRegras();
            $('#input').keypress(function(e){
                if(e.keyCode==13)
                    $('#btn_aplicar').click();
            });
        });

        function inserirCaracter(button) {
            var inputTxt = $('#input');
            var cursorPos = inputTxt.textrange().position;
            var txt1 = inputTxt.val().slice(0, cursorPos);
            var txt2 = inputTxt.val().slice(cursorPos);
            inputTxt.val(txt1 + $(button).text() + txt2);
            inputTxt.textrange('setcursor', cursorPos + 1);
        }

        function loadRegras() {
            for (var i = 0 ; i < numSincronias; i++) {
                var sincroniaId = "s" + i;
                getFileFromServer("regras/" + sincroniaId + ".txt", fillTextArea, sincroniaId);
            }
            getFileFromServer("regras/conjuntos.txt", fillTextArea, "conjuntos");
            getFileFromServer("regras/ortografico-fonetico.txt", fillTextArea, "orto2fone");
            getFileFromServer("regras/fonetico-ortografico.txt", fillTextArea, "fone2orto");
            getFileFromServer("regras/ortografico-fonologico.txt", storeRegras, _regrasOrto2Fono);
            getFileFromServer("regras/fonologico-ortografico.txt", storeRegras, _regrasFono2Orto);
        }

        function fillTextArea(text, idTextArea) {
            if (text === null) {
                console.log('Erro ao ler arquivo.');
            } else {
                $('#' + idTextArea).val(text);
            }
        }

        function storeRegras(text, array) {
            if (text === null) {
                console.log('Erro ao ler arquivo.');
            } else {
                array.push.apply(array, parseRegras(text)); // Adiciona todas regras em array.
            }
        }

        function lerRegras() {
            _sincronias = [];
            for (var i = 0 ; i < numSincronias; i++) {
                var sincroniaId = "s" + i;
                var text = $('#' + sincroniaId).val();
                var regras = parseRegras(text);
                _sincronias.push(regras);
            }
            _regrasOrto2Fone = parseRegras($('#orto2fone').val());
            _regrasFone2Orto = parseRegras($('#fone2orto').val());
        }

        function parseRegras(text) {
            var mapaRegras = {}; // key: origem da regra; value: array de regras
            var regexSpaces = new RegExp('[ \\[\\]\r\n]', 'g');
            var lines = text.split('\n')
            for (var j = 0; j < lines.length; j++) {
                var line = lines[j].replace(regexSpaces, '');
                if (!line || 0 === line.length)
                    continue;

                var parts = line.split('>'); // Trim spaces
                var novaRegra;
                if (parts.length == 2) {
                    novaRegra = new Regra(parts[0], parts[1]);
                } else if (parts.length == 1) {
                    novaRegra = new Regra(parts[0], '');
                }
                if (novaRegra.origem in mapaRegras) {
                    mapaRegras[novaRegra.origem].push(novaRegra); // Adiciona no array
                } else {
                    mapaRegras[novaRegra.origem] = [ novaRegra ]; // Cria o array
                }
            }
            var regras = [];
            for (var key in mapaRegras) {
                // Verifica se existem regras ambiguas
                if (mapaRegras[key].length > 1) {
                    regras.push(new RegraAmbigua(mapaRegras[key]));
                } else {
                    regras.push(mapaRegras[key][0]);
                }
            }
            return regras;
        }

        function lerConjuntos() {
            _conjuntos = {};
            var regexSpaces = new RegExp('[ {}]', 'g');
            var lines = $('#conjuntos').val().split('\n');
            for (var i = 0; i < lines.length; i++) {
                var parts = lines[i].replace(regexSpaces, '').split('=');
                if (parts.length == 2) {
                    _conjuntos[parts[0]] = parts[1].split(',');
                }
            }
        }

        function mudarModo() {
            _modo = (_modo + 1) % 3;
            $('#btn-modo').text("Modo: " + modosnomes[_modo]);

            switch (_modo) {
                case modos.ORTOGRAFICO:
                    $('#input').val(_input);
                    break;
                case modos.FONETICO:
                    _input = $('#input').val().trim().toLowerCase();
                    var fonetico = transformar(_regrasOrto2Fone, _input);
                    $('#input').val(fonetico[0]);
                    break;
                case modos.FONOLOGICO:
                    break;
            }
        }

        function transformar(regras, input) {
            var inputAtual = [ input ];
            for (var j = 0; j < regras.length; j++) {
                var auxInputAtual = [];
                for (var k = 0; k < inputAtual.length; k++) {
                    var regraOutputs = regras[j].aplicar(inputAtual[k]);
                    auxInputAtual = auxInputAtual.concat(regraOutputs);
                }
                inputAtual = auxInputAtual;
            }
            return inputAtual;
        }

        function aplicarRegras() {
            lerConjuntos();
            lerRegras();
            var input = new Cadeia($('input').val().trim().toLowerCase());
            console.log('Input: ' + input);

            var inputFoneticos = transformar(_regrasOrto2Fone, input);
            var inputFonologicos = transformar(_regrasOrto2Fono, input);
            showInputs(input, inputFoneticos, inputFonologicos);

            var lastOutputs = inputFoneticos;
            var fullOutputs = [];
            for (var i = 0; i < inputFoneticos.length; i++) {
                fullOutputs.push('[' + inputFoneticos[i].str + ']');
            }

            for (var s = 0; s < _sincronias.length; s++) {
                var regras = _sincronias[s];
                // Auxliliares para não perder o controle da iteração 'i', pois os vetores mudam de tamanho.
                var auxOutputs = [];
                var auxFullOutputs = [];
                for (var i = 0; i < lastOutputs.length; i++) {
                    var inputAtual = [ lastOutputs[i] ];
                    for (var j = 0; j < regras.length; j++) {
                        var auxInputAtual = [];
                        for (var k = 0; k < inputAtual.length; k++) {
                            var regraOutputs = regras[j].aplicar(inputAtual[k]);
                            auxInputAtual = auxInputAtual.concat(regraOutputs);
                        }
                        inputAtual = auxInputAtual;
                    }

                    auxOutputs = auxOutputs.concat(inputAtual);
                    for (var k = 0; k < inputAtual.length; k++) {
                        auxFullOutputs.push(fullOutputs[i].concat(' > [', inputAtual[k].str, ']'));
                    }
                }
                lastOutputs = auxOutputs;
                fullOutputs = auxFullOutputs;
            }

            // Transformar de volta
            var lastOutputsOrto = [];
            for (var i = 0; i < lastOutputs.length; i++) {
                lastOutputsOrto.push(transformar(_regrasFone2Orto, lastOutputs[i]));
            }

            var fullOutput = '';
            var lastOutput = '';
            for (var k = 0; k < fullOutputs.length; k++) {
                fullOutput += fullOutputs[k] + '\n';
                for (var i = 0; i < lastOutputsOrto[k].length; i++) {
                    if (i > 0)
                        lastOutput += ', ';
                    lastOutput += lastOutputsOrto[k][i];
                }
                lastOutput += '\n';
            }

            $('#fulloutput').text(fullOutput);
            $('#fulloutput').html($('#fulloutput').html().replace(/\n/g,'<br/>'));
            $('#output').text(lastOutput);
            $('#output').html($('#output').html().replace(/\n/g,'<br/>'));
        }

        // inOrto: string, inFone e inFono: array de strings
        function showInputs(inOrto, inFone, inFono) {
            $('#input-ortografico').text(inOrto.str);
            var strFonetico = '';
            for (var i = 0; i < inFone.length; i++) {
                strFonetico += '[' + inFone[i].str + ']';
                if (i < inFone.length - 1) {
                    strFonetico += ', ';
                }
            }
            $('#input-fonetico').text(strFonetico);
            var strFonologico = '';
            for (var i = 0; i < inFono.length; i++) {
                strFonologico += '/' + inFono[i].str + '/';
                if (i < inFono.length - 1) {
                    strFonologico += ', ';
                }
            }
            $('#input-fonologico').text(strFonologico);
        }
    </script>

</body>
</html>